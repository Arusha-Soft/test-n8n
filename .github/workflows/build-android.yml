name: Build Android
on:
  push:
    branches:
      - 'Build/android/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'Build/android/test'
        type: choice
        options:
          - Build/android/test
          - Build/android/release

concurrency:
  group: android-${{ github.ref }}
  cancel-in-progress: true

jobs:
  queue-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with LFS
        uses: actions/checkout@v4
        with:
          lfs: true
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Debug local actions
        run: |
          echo "Branch = ${{ github.event.inputs.branch || github.ref }}"
          echo "Workspace = $GITHUB_WORKSPACE"
          ls -R .github/actions || true

      - name: Determine build flavor
        run: |
          CURRENT_REF="${{ github.event.inputs.branch || github.ref }}"
          if [[ "$CURRENT_REF" == *"/test" ]]; then
            echo "FLAVOR=dev" >> $GITHUB_ENV
            echo "DEVELOPMENT=true" >> $GITHUB_ENV
          else
            echo "FLAVOR=release" >> $GITHUB_ENV
            echo "DEVELOPMENT=false" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Notify build queued
        uses: ./.github/actions/telegram-notify
        with:
          status: queued
          platform: Anroid
          flavor: ${{ env.FLAVOR }}
          bot_server_ip: ${{ secrets.TELEGRAM_BOT_SERVER_IP }}
          bot_server_port: ${{ secrets.TELEGRAM_BOT_SERVER_PORT }}
          bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          chat_thread_id: ${{ secrets.TELEGRAM_CHAT_THREAD_ID }}

  build-android:
    runs-on: ubuntu-latest
    needs: queue-notify
    env:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

    steps:
    - name: Start time
      run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
      shell: bash

    - name: Checkout with LFS
      uses: actions/checkout@v4
      with:
        lfs: true
        ref: ${{ github.event.inputs.branch || github.ref }}
        
    - name: Debug local actions
      run: |
        echo "Branch = ${{ github.event.inputs.branch || github.ref }}"
        echo "Workspace = $GITHUB_WORKSPACE"
        ls -R .github/actions || true

    - name: Parse project settings
      uses: ./.github/actions/parse-project-settings
      id: project_settings

    - name: Determine build flavor
      run: |
        CURRENT_REF="${{ github.event.inputs.branch || github.ref }}"
        if [[ "$CURRENT_REF" == *"/test" ]]; then
          echo "flavor=dev"
          echo "FLAVOR=dev" >> $GITHUB_ENV
          echo "DEVELOPMENT=true" >> $GITHUB_ENV
          echo "ANDROID_EXPORT_TYPE=androidPackage" >> $GITHUB_ENV
        else
        echo "flavor=release"
          echo "FLAVOR=release" >> $GITHUB_ENV
          echo "DEVELOPMENT=false" >> $GITHUB_ENV
          echo "ANDROID_EXPORT_TYPE=androidAppBundle" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Check for keystore and secrets
      id: check_keystore
      run: |
        if [ -f "key.keystore" ] && [ -n "${{ secrets.ANDROID_KEYSTORE_PASS }}" ] && [ -n "${{ secrets.ANDROID_KEY_ALIAS_NAME }}" ] && [ -n "${{ secrets.ANDROID_KEY_ALIAS_PASS }}" ]; then
          echo "has_keystore=true" >> $GITHUB_OUTPUT
          # Encode keystore to base64
          base64 -w 0 key.keystore > keystore_base64.txt
          echo "keystore_base64=$(cat keystore_base64.txt)" >> $GITHUB_OUTPUT
          rm keystore_base64.txt
        else
          echo "has_keystore=false" >> $GITHUB_OUTPUT
          echo "keystore_base64=" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Send build start notification
      uses: ./.github/actions/telegram-notify
      with:
        status: start
        platform: Android
        flavor: ${{ env.FLAVOR }}
        bot_server_ip: ${{ secrets.TELEGRAM_BOT_SERVER_IP }}
        bot_server_port: ${{ secrets.TELEGRAM_BOT_SERVER_PORT }}
        bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
        chat_thread_id: ${{ secrets.TELEGRAM_CHAT_THREAD_ID }}

    - name: Cache Library
      uses: actions/cache@v3
      with:
        path: Library
        key: unity-${{ steps.project_settings.outputs.unity_version }}-android-${{ hashFiles('Packages/manifest.json', 'Packages/packages-lock.json') }}
        restore-keys: |
          unity-${{ steps.project_settings.outputs.unity_version }}-android-

    - name: Free disk space
      uses: jlumbroso/free-disk-space@v1.3.1

    - name: Build Android
      uses: game-ci/unity-builder@v4
      id: unity-builder
      with:
        unityVersion: ${{ steps.project_settings.outputs.unity_version }}
        targetPlatform: Android
        buildMethod: BuildScript.BuildAndroid
        customParameters: -development ${{ env.DEVELOPMENT }}
        androidExportType: ${{ env.ANDROID_EXPORT_TYPE }}
        androidKeystoreName: ${{ steps.check_keystore.outputs.has_keystore == 'true' && 'key.keystore' || '' }}
        androidKeystoreBase64: ${{ steps.check_keystore.outputs.keystore_base64 }}
        androidKeystorePass: ${{ steps.check_keystore.outputs.has_keystore == 'true' && secrets.ANDROID_KEYSTORE_PASS || '' }}
        androidKeyaliasName: ${{ steps.check_keystore.outputs.has_keystore == 'true' && secrets.ANDROID_KEY_ALIAS_NAME || '' }}
        androidKeyaliasPass: ${{ steps.check_keystore.outputs.has_keystore == 'true' && secrets.ANDROID_KEY_ALIAS_PASS || '' }}
        customImage: ''
        sshAgent: ''
        gitPrivateToken: ''
        chownFilesTo: ''
        allowDirtyBuild: true
      env:
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        UNITY_LICENSE: ${{ env.UNITY_LICENSE }}

    - name: Fix permissions for build outputs
      run: |
        sudo chown -R "$USER":"$USER" build/Android
        chmod -R u+rwX build/Android

    - name: Prepare Android artifacts
      run: |
        cd build/Android
        
        echo "=== Listing contents of build/Android BEFORE renaming ==="
        ls -lah
        echo "========================================================="

        BASE_NAME="${{ steps.project_settings.outputs.base_filename }}"
        
        # Rename APK/AAB files
        if compgen -G "*.apk" > /dev/null; then
          for apk in *.apk; do
            mv "$apk" "${BASE_NAME}.apk"
          done
        fi
        
        if compgen -G "*.aab" > /dev/null; then
          for aab in *.aab; do
            mv "$aab" "${BASE_NAME}.aab"
          done
        fi
        
        # Create a directory for the artifact
        ARTIFACT_NAME="${BASE_NAME}_Android"
        mkdir -p "$ARTIFACT_NAME"
        shopt -s dotglob
        mv -- * "$ARTIFACT_NAME"/ 2>/dev/null || true
        shopt -u dotglob
        
        echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
      shell: bash

    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: build/Android/${{ env.ARTIFACT_NAME }}
        retention-days: 1

    - name: Create archive for Telegram
      if: success()
      run: |
        cd build/Android
        # Install p7zip if not available
        sudo apt-get update && sudo apt-get install -y p7zip-full
          
        # Create split archive (2GB parts)
        7z a -v2g "${{ env.ARTIFACT_NAME }}.7z" "${{ env.ARTIFACT_NAME }}"
        echo "ARCHIVE_FILES=$(ls ${{ env.ARTIFACT_NAME }}.7z.* 2>/dev/null | tr '\n' ' ')" >> $GITHUB_ENV
      shell: bash

    - name: Calculate duration
      if: always()
      run: |
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - ${{ env.START_TIME }}))
        echo "DURATION=$(printf '%02d:%02d' $(($DURATION/60)) $(($DURATION%60)))" >> $GITHUB_ENV
      shell: bash

    - name: Generate success message
      if: success()
      run: |
        # Source the message generator script
        source .github/scripts/generate-telegram-message.sh
          
        # Generate the exact same message format
        MESSAGE=$(generate_telegram_message "end" "success" "${{ env.DURATION }}" "${{ env.ARTIFACT_NAME }}" "Android" "${{ env.FLAVOR }}")
          
        # Store the message in environment variable
        echo "TELEGRAM_MESSAGE<<EOF" >> $GITHUB_ENV
        echo "$MESSAGE" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
      shell: bash

    - name: Upload archive to Telegram
      if: success() && env.ARCHIVE_FILES != ''
      uses: ./.github/actions/telegram-sendfile
      with:
        files: build/Android/${{ env.ARTIFACT_NAME }}.7z.*
        caption: ${{ env.TELEGRAM_MESSAGE }}
        bot_server_ip: ${{ secrets.TELEGRAM_BOT_SERVER_IP }}
        bot_server_port: ${{ secrets.TELEGRAM_BOT_SERVER_PORT }}
        bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
        chat_thread_id: ${{ secrets.TELEGRAM_CHAT_THREAD_ID }}

    - name: Send build end notification
      if: always() && (failure() || cancelled())
      uses: ./.github/actions/telegram-notify
      with:
        status: end
        result: ${{ job.status }}
        duration: ${{ env.DURATION }}
        artifact_name: ${{ env.ARTIFACT_NAME }}
        platform: Android
        flavor: ${{ env.FLAVOR }}
        bot_server_ip: ${{ secrets.TELEGRAM_BOT_SERVER_IP }}
        bot_server_port: ${{ secrets.TELEGRAM_BOT_SERVER_PORT }}
        bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
        chat_thread_id: ${{ secrets.TELEGRAM_CHAT_THREAD_ID }}