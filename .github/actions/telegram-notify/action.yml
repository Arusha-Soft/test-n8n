name: 'Telegram Notification'
description: 'Send Telegram notification for build status'
inputs:
  status:
    description: 'Status type (start/end)'
    required: true
  result:
    description: 'Build result (success/failure/cancelled)'
    required: false
    default: ''
  duration:
    description: 'Build duration'
    required: false
    default: ''
  artifact_name:
    description: 'Artifact name'
    required: false
    default: ''
  platform:
    description: 'Build platform'
    required: true
  flavor:
    description: 'Build flavor (dev/release)'
    required: true
  bot_server_ip:
    description: 'Telegram Bot Server IP'
    required: true
    default: ''
  bot_server_port:
    description: 'Telegram Bot Server Port'
    required: true
    default: '8081'
  bot_token:
    description: 'Telegram Bot Token'
    required: true
    default: ''
  chat_id: 
    description: 'Telegram Chat ID'
    required: true
    default: ''
  chat_thread_id:
    description: 'Telegram Chat Thread ID (for groups)'
    required: true
    default: ''
  # project_name:
  #   description: 'Optional display name for the project'
  #   required: false
  #   default: ''

runs:
  using: composite
  steps:
    - name: Check Telegram secrets
      id: check_telegram
      run: |
        if [ -n "${{ inputs.bot_token }}" ] && [ -n "${{ inputs.chat_id }}" ]; then
          echo "has_telegram=true" >> $GITHUB_OUTPUT
        else
          echo "has_telegram=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Send Telegram notification
      if: steps.check_telegram.outputs.has_telegram == 'true'
      shell: bash
      run: |
        # Choose a friendly title (use repo; uncomment to prefer custom project name)
        TITLE="$(basename "${{ github.repository }}")"
        # [ -n "${{ inputs.project_name }}" ] && TITLE="${{ inputs.project_name }}"

        # Human-readable status line + emoji
        if [ "${{ inputs.status }}" = "start" ]; then
          STATUS="ğŸš€ Started"
        elif [ "${{ inputs.status }}" = "queued" ]; then
          STATUS="ğŸ•“ Queued"
        else
          case "${{ inputs.result }}" in
            success)   STATUS="âœ… Success" ;;
            failure)   STATUS="âŒ Failed" ;;
            cancelled) STATUS="â¹ï¸ Cancelled" ;;
            *)         STATUS="â„¹ï¸ Info" ;;
          esac
        fi

        MESSAGE="[ğŸ® Project: ${TITLE}]
        =============================

        ğŸ–¥ï¸ Platform:   ${{ inputs.platform }}
        ğŸ¨ Flavor:     ${{ inputs.flavor }}
        ğŸ“¦ Repo:       ${{ github.repository }}
        ğŸŒ¿ Branch:     ${{ github.ref_name }}
        ğŸ”‘ Commit:     ${GITHUB_SHA:0:7}
        ğŸ‘¤ By:         ${{ github.actor }}

        =============================
        ğŸ“Š Build Status: ${STATUS}
        ============================="

        if [ "${{ inputs.status }}" != "start" ] && [ "${{ inputs.status }}" != "queued" ]; then
          MESSAGE="${MESSAGE}
          â±ï¸ Duration:   ${{ inputs.duration }}
          ğŸ“ Artifact:   ${{ inputs.artifact_name }}"
        fi

        MESSAGE="${MESSAGE}

        â¡ï¸ Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        -----------------------------
        Â©ï¸ Arusha Soft"

        echo "---- MESSAGE START ----"
        echo "$MESSAGE"
        echo "---- MESSAGE END ----"

        curl -s "http://${{inputs.bot_server_ip}}:${{inputs.bot_server_port}}/bot${{ inputs.bot_token }}/sendMessage" \
          -d chat_id="${{ inputs.chat_id }}" \
          -d message_thread_id="${{ inputs.chat_thread_id }}" \
          --data-urlencode text="$MESSAGE" \
          -d disable_web_page_preview=true
